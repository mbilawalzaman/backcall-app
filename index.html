<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contacts Table</title>
  <style>
    /* Reset basic styling */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background-color: #f4f4f9;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      flex-direction: column;
      padding: 20px;
    }

    h3 {
      text-align: center;
      margin-bottom: 20px;
      color: #4CAF50;
    }

    /* Form Styling */
    #contactForm {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 500px;
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 16px;
      margin-bottom: 8px;
      font-weight: bold;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    button {
      background-color: #4CAF50;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      margin-top: 10px;
    }

    button:hover {
      background-color: #45a049;
    }

    /* Table Styling */
    table {
      width: 100%;
      max-width: 800px;
      margin-top: 20px;
      border-collapse: collapse;
      background-color: #fff;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #4CAF50;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    /* Delete Icon Styling */
    .delete-icon {
      color: #f44336;
      cursor: pointer;
      font-size: 20px;
      text-align: center;
      padding: 5px;
    }

    .delete-icon:hover {
      color: #d32f2f;
      cursor: pointer; /* Ensures cursor is a pointer */
    }

    .edit-icon {
      color: #4CAF50;
      cursor: pointer;
      font-size: 20px;
      text-align: center;
      padding: 5px;
    }

    .edit-icon:hover {
      color: #388E3C;
      cursor: pointer; /* Ensures cursor is a pointer */
    }

    /* Buttons Styling */
    .action-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 800px;
    }

    .action-buttons button, .action-buttons input {
      padding: 12px 20px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    .action-buttons button {
      background-color: #007BFF;
      color: white;
      cursor: pointer;
    }

    .action-buttons button:hover {
      background-color: #0056b3;
    }

    .action-buttons input[type="file"] {
      border: none;
    }

  </style>
</head>
<body>

  <!-- Form for adding new contact -->
  <h3>Add New Contact</h3>
  <form id="contactForm">
    <label for="name">Name:</label>
    <input type="text" id="name" required><br>
    
    <label for="number">Number:</label>
    <input type="text" id="number" required><br>
    
    <label for="details">Details (Comma-separated):</label>
    <input type="text" id="details" required><br>

    <label for="reminder">Reminder Date & Time:</label>
    <input type="datetime-local" id="reminder" required><br>
    
    <button type="submit">Add Contact</button>
  </form>

  <hr>

  <!-- Contacts Table -->
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Number</th>
        <th>Callback Details</th>
        <th>Reminder</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="contactsTableBody">
    </tbody>
  </table>

  <div class="action-buttons">
    <!-- Download CSV Button -->
    <button id="downloadCsv">Download CSV</button>
    
    <!-- Upload CSV Button -->
    <input type="file" id="uploadCsv" accept=".csv">
    <button id="uploadCsvButton">Upload CSV</button>
  </div>

<script>
  // Check if the Page Visibility API is supported
  const isPageVisible = () => {
    console.log("Page visibility state:", document.visibilityState); // Debugging log
    return document.visibilityState === 'visible';
  };

  // Check if Notifications API is supported
  const isNotificationSupported = "Notification" in window;

  // Request notification permission from the user
  if (isNotificationSupported && Notification.permission !== "granted") {
    Notification.requestPermission().then(permission => {
      if (permission === "granted") {
        console.log("Notification permission granted.");
      } else {
        console.log("Notification permission denied.");
      }
    });
  }

  // Load contacts from localStorage or initialize an empty array
  const storedContacts = localStorage.getItem('contacts');
  const contacts = storedContacts ? JSON.parse(storedContacts) : [];

  // Function to render the table
  const tableBody = document.getElementById('contactsTableBody');
  const renderTable = () => {
    tableBody.innerHTML = contacts.map((contact, index) => {
      const details = contact.details.join(", ");
      const reminder = contact.reminder ? new Date(contact.reminder).toLocaleString() : "No reminder set";
      return `
        <tr data-index="${index}">
          <td>${contact.name}</td>
          <td>${contact.number}</td>
          <td>${details}</td>
          <td>${reminder}</td>
          <td><span class="delete-icon" data-index="${index}">&#10006;</span> | <span class="edit-icon" data-index="${index}">&#9998;</span></td>
        </tr>
      `;
    }).join('');
  };

  // Initial render of the table
  renderTable();

  // Handle form submission to add a new contact or edit an existing one
  const contactForm = document.getElementById('contactForm');
  let editIndex = -1; // To track the index of the contact being edited

  contactForm.addEventListener('submit', function(event) {
    event.preventDefault();

    // Get form values
    const name = document.getElementById('name').value;
    const number = document.getElementById('number').value;
    const details = document.getElementById('details').value.split(',').map(item => item.trim());
    const reminder = document.getElementById('reminder').value;

    if (editIndex === -1) {
      // Add new contact
      const newContact = { name, number, details, reminder };
      contacts.push(newContact);
    } else {
      // Update existing contact
      contacts[editIndex].name = name;
      contacts[editIndex].number = number;
      contacts[editIndex].details = details;
      contacts[editIndex].reminder = reminder;

      // Show success alert for update
      alert("Number updated successfully");

      // Reset edit mode
      editIndex = -1;
    }

    // Save updated contacts to local storage
    localStorage.setItem('contacts', JSON.stringify(contacts));

    // Re-render the table with updated data
    renderTable();

    // Reset form
    contactForm.reset();
    contactForm.querySelector('button').textContent = 'Add Contact'; // Reset the button to "Add Contact"
  });

  // Function to delete a contact
  const deleteContact = (index) => {
    contacts.splice(index, 1); // Remove the contact from the array
    localStorage.setItem('contacts', JSON.stringify(contacts)); // Update localStorage
    renderTable(); // Re-render the table after deletion
  };

  // Function to handle editing a contact
  const editContact = (index) => {
    const contact = contacts[index];
    document.getElementById('name').value = contact.name;
    document.getElementById('number').value = contact.number;
    document.getElementById('details').value = contact.details.join(', ');
    document.getElementById('reminder').value = contact.reminder || '';
    editIndex = index; // Set the edit mode for this contact
    document.querySelector('button[type="submit"]').textContent = 'Update Contact'; // Change button text to "Update"
  };

  // Event listener for delete and edit actions
  tableBody.addEventListener('click', (event) => {
    const index = event.target.getAttribute('data-index');
    if (event.target.classList.contains('delete-icon')) {
      if (confirm("Are you sure you want to delete this contact?")) {
        deleteContact(index);
      }
    } else if (event.target.classList.contains('edit-icon')) {
      editContact(index);
    }
  });

  // Function to check reminders every 3 seconds
 const checkReminders = () => {
  const now = new Date();
  console.log("Current time:", now);

  contacts.forEach(contact => {
    if (contact.reminder) {
      const reminderTime = new Date(contact.reminder);
      console.log("Reminder time for", contact.name, ":", reminderTime);

      if (now >= reminderTime) {
        console.log("Reminder triggered for", contact.name);

        if (!isPageVisible()) {
          // The page is in the background, show a notification
          if (isNotificationSupported && Notification.permission === "granted") {
            new Notification(`Reminder for ${contact.name}`, {
              body: `Reminder: ${contact.details.join(", ")}`,
            });
          }
        } else {
          // The page is visible, show an alert
          alert(`Reminder for ${contact.name}: ${contact.details.join(", ")}`);
        }
        
        // Remove the reminder after showing it
        contact.reminder = null;
      }
    }
  });

  // Save the updated contacts (with no reminders) back to local storage
  localStorage.setItem('contacts', JSON.stringify(contacts));
};

// Check reminders every 30 seconds
setInterval(checkReminders, 30000);


  // Check reminders every 3 seconds
  setInterval(checkReminders, 3000);

  // Download contacts as CSV
  document.getElementById('downloadCsv').addEventListener('click', () => {
    let csvContent = "Name,Number,Details,Reminder\n";
    contacts.forEach(contact => {
      csvContent += `${contact.name},${contact.number},${contact.details.join(", ")},${contact.reminder || "No reminder"}\n`;
    });

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'contacts.csv';
    link.click();
  });

  // Upload contacts from CSV file
  document.getElementById('uploadCsv').addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file && file.type === 'text/csv') {
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        const rows = content.split('\n').map(row => row.split(','));
        rows.forEach((row, index) => {
          if (index > 0 && row.length >= 4) { // Skip header row
            const [name, number, details, reminder] = row;
            const contact = {
              name,
              number,
              details: details.split(' ').map(item => item.trim()), // Clean up spaces in details
              reminder: reminder !== "No reminder" ? reminder : null,
            };
            contacts.push(contact);
          }
        });

        localStorage.setItem('contacts', JSON.stringify(contacts)); // Save to local storage
        renderTable(); // Re-render the table with new data
      };
      reader.readAsText(file);
    }
  });
</script>

</body>
</html>
